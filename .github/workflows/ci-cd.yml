name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/** ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.10.1)'
        required: false
        default: ''

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_FILE: 'AppiumBootstrapInstaller.sln'
  PROJECT_FILE: 'AppiumBootstrapInstaller/AppiumBootstrapInstaller.csproj'
  BUILD_CONFIGURATION: 'Release'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Build solution
      run: dotnet build ${{ env.SOLUTION_FILE }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore

    - name: Run tests
      run: dotnet test ${{ env.SOLUTION_FILE }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: '**/*.trx'

    - name: Publish Windows x64
      run: dotnet publish ${{ env.PROJECT_FILE }} --configuration ${{ env.BUILD_CONFIGURATION }} --runtime win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true --output ./publish-temp

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: ./publish-temp/
        retention-days: 30

  create-release-package:
    name: Create Release Package
    runs-on: windows-latest
    needs: build-and-test
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || github.event_name == 'workflow_dispatch'

    steps:
    - name: Debug workflow context
      run: |
        echo "Event name: ${{ github.event_name }}"
        echo "Ref: ${{ github.ref }}"
        echo "Version input: ${{ inputs.version }}"
        
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-build
        path: ./publish-temp

    - name: Setup release version
      id: version
      run: |
        $inputVersion = "${{ inputs.version }}"
        if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch' -and $inputVersion) {
          $version = $inputVersion
          Write-Host "Using version from workflow input: $version"
        } elseif ($env:GITHUB_REF -match 'refs/tags/v(.+)') {
          $version = $matches[1]
          Write-Host "Using version from tag: $version"
        } else {
          # Get version from VERSION file
          $version = Get-Content "publish\VERSION" -Raw
          $version = $version.Trim()
          Write-Host "Using version from VERSION file: $version"
        }
        echo "RELEASE_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "version=$version" >> $env:GITHUB_OUTPUT

    - name: Copy build to publish directory
      run: |
        # Clean publish directory except docs and config files
        Get-ChildItem "publish" -Exclude "docs", "*.json", "*.md", "LICENSE", "VERSION" | Remove-Item -Recurse -Force

        # Copy build artifacts
        Copy-Item "publish-temp\*" -Destination "publish\" -Force

        # Update VERSION file
        $version | Out-File -FilePath "publish\VERSION" -Encoding utf8

    - name: Create release archive
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $archiveName = "AppiumBootstrapInstaller-v$version.zip"
        Compress-Archive -Path "publish\*" -DestinationPath $archiveName -Force

        # Calculate checksum
        $hash = Get-FileHash $archiveName -Algorithm SHA256
        "$($hash.Hash)  $archiveName" | Out-File -FilePath "$archiveName.sha256" -Encoding utf8

    - name: Upload release package
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: |
          AppiumBootstrapInstaller-v*.zip
          AppiumBootstrapInstaller-v*.zip.sha256
        retention-days: 90

  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: create-release-package
    if: (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) || github.event_name == 'workflow_dispatch'

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download release package
      uses: actions/download-artifact@v4
      with:
        name: release-package

    - name: Get release version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ -n "${{ inputs.version }}" ]]; then
          version="${{ inputs.version }}"
          echo "Using version from workflow input: $version"
        elif [[ $GITHUB_REF =~ refs/tags/v(.+) ]]; then
          version="${BASH_REMATCH[1]}"
          echo "Using version from tag: $version"
        else
          # Get version from VERSION file
          version=$(cat publish/VERSION | tr -d '[:space:]')
          echo "Using version from VERSION file: $version"
        fi
        echo "RELEASE_VERSION=$version" >> $GITHUB_ENV
        echo "version=$version" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        prerelease: true
        body: |
          ## ðŸš€ Appium Bootstrap Installer v${{ steps.version.outputs.version }} (Pre-release)

          **âš ï¸ This is a pre-release version. Use with caution in production environments.**

          ### ðŸ“¦ Downloads
          - **Windows:** [AppiumBootstrapInstaller-v${{ steps.version.outputs.version }}.zip](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/AppiumBootstrapInstaller-v${{ steps.version.outputs.version }}.zip)

          ### âœ¨ What's New
          - See [RELEASE_NOTES.md](https://github.com/${{ github.repository }}/blob/main/RELEASE_NOTES.md) for detailed changelog

          ### ðŸ› ï¸ Installation
          ```bash
          # Download and extract
          curl -L https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/AppiumBootstrapInstaller-v${{ steps.version.outputs.version }}.zip -o installer.zip
          unzip installer.zip
          cd AppiumBootstrapInstaller-v${{ steps.version.outputs.version }}

          # Run (Windows as Administrator)
          .\AppiumBootstrapInstaller.exe
          ```

          ### ðŸ”§ System Requirements
          - Windows 10/11 (64-bit)
          - 4GB RAM minimum, 8GB recommended
          - 2GB free disk space
          - Administrator privileges for service installation
        files: |
          AppiumBootstrapInstaller-v*.zip
          AppiumBootstrapInstaller-v*.zip.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-multiplatform:
    name: Build Multi-Platform
    runs-on: ${{ matrix.os }}
    needs: build-and-test
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
            artifact-name: windows-x64
          - os: macos-latest
            runtime: osx-x64
            artifact-name: macos-x64
          - os: macos-latest
            runtime: osx-arm64
            artifact-name: macos-arm64
          - os: ubuntu-latest
            runtime: linux-x64
            artifact-name: linux-x64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}

    - name: Publish ${{ matrix.runtime }}
      run: dotnet publish ${{ env.PROJECT_FILE }} --configuration ${{ env.BUILD_CONFIGURATION }} --runtime ${{ matrix.runtime }} --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true --output ./publish-${{ matrix.artifact-name }}

    - name: Create platform archive (Windows)
      if: runner.os == 'Windows'
      run: |
        Compress-Archive -Path "./publish-${{ matrix.artifact-name }}/*" -DestinationPath "AppiumBootstrapInstaller-${{ matrix.runtime }}.zip" -Force
      shell: pwsh

    - name: Create platform archive (Unix)
      if: runner.os != 'Windows'
      run: |
        cd ./publish-${{ matrix.artifact-name }}
        zip -r "../AppiumBootstrapInstaller-${{ matrix.runtime }}.zip" .
        cd ..
      shell: bash

    - name: Upload platform build
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}-build
        path: AppiumBootstrapInstaller-${{ matrix.runtime }}.zip
        retention-days: 90

  update-release-with-multiplatform:
    name: Update Release with Multi-Platform Builds
    runs-on: ubuntu-latest
    needs: [publish-release, build-multiplatform]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
    - name: Get release version
      id: version
      run: |
        if [[ $GITHUB_REF =~ refs/tags/v(.+) ]]; then
          version="${BASH_REMATCH[1]}"
          echo "version=$version" >> $GITHUB_OUTPUT
        fi

    - name: Download all platform builds
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Update release with multi-platform downloads
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}
        append_body: true
        body: |
          ### ðŸ“¦ Multi-Platform Downloads

          | Platform | Architecture | Download |
          |----------|---------------|----------|
          | Windows | x64 | [AppiumBootstrapInstaller-win-x64.zip](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/AppiumBootstrapInstaller-win-x64.zip) |
          | macOS | Intel (x64) | [AppiumBootstrapInstaller-osx-x64.zip](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/AppiumBootstrapInstaller-osx-x64.zip) |
          | macOS | Apple Silicon (ARM64) | [AppiumBootstrapInstaller-osx-arm64.zip](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/AppiumBootstrapInstaller-osx-arm64.zip) |
          | Linux | x64 | [AppiumBootstrapInstaller-linux-x64.zip](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/AppiumBootstrapInstaller-linux-x64.zip) |

          ### ðŸ”§ Quick Start by Platform

          **Windows:**
          ```powershell
          # Download
          curl -L https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/AppiumBootstrapInstaller-win-x64.zip -o installer.zip
          # Extract and run as Administrator
          .\AppiumBootstrapInstaller.exe
          ```

          **macOS:**
          ```bash
          # Download (choose architecture)
          curl -L https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/AppiumBootstrapInstaller-osx-x64.zip -o installer.zip
          # Extract and run
          unzip installer.zip
          chmod +x AppiumBootstrapInstaller
          ./AppiumBootstrapInstaller
          ```

          **Linux:**
          ```bash
          # Download
          curl -L https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/AppiumBootstrapInstaller-linux-x64.zip -o installer.zip
          # Extract and run
          unzip installer.zip
          chmod +x AppiumBootstrapInstaller
          ./AppiumBootstrapInstaller
          ```
        files: |
          ./artifacts/*/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}